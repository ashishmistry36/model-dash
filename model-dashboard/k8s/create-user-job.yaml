# Job to create a local admin user for testing
apiVersion: batch/v1
kind: Job
metadata:
  name: create-admin-user
  namespace: model-dashboard
spec:
  ttlSecondsAfterFinished: 300
  template:
    spec:
      restartPolicy: OnFailure
      initContainers:
      # Wait for dashboard to be ready
      - name: wait-for-dashboard
        image: busybox:1.36
        command: ['sh', '-c', 'until nc -z model-dashboard 8000; do echo waiting for dashboard; sleep 2; done; echo dashboard is ready']
      containers:
      - name: create-user
        image: model-dashboard:latest
        imagePullPolicy: Never
        command:
        - /bin/sh
        - -c
        - |
          set -e
          python /app/scripts/manage_users.py create admin admin123 "Admin User" --email admin@example.com || echo "User may already exist"
          python /app/scripts/manage_users.py create testuser test123 "Test User" --email test@example.com || echo "User may already exist"
          echo "Users created/verified!"
          python /app/scripts/manage_users.py list
        env:
        - name: AUTH_DB_PATH
          value: "/data/auth/users.db"
        volumeMounts:
        - name: data
          mountPath: /data
      volumes:
      - name: data
        persistentVolumeClaim:
          claimName: model-dashboard-data
